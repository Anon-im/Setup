#!/bin/bash
set -e
cd ../app/build/

while true; do
  JOBNUM=$(curl -s http://$JOB_SERVER_HOST/job)
  if [ -z "$JOBNUM" ]; then
    sleep 1
    continue
  fi
  echo Computing range polynomial $JOBNUM
  START=`date +%s`
  RESULT=$(./compute_range_polynomial $JOBNUM $POLYNOMIAL_DEGREE)
  END=`date +%s`
  if [ -n "$RESULT" ]; then
    curl -s -X PUT -d "$RESULT" -H "Content-Type: text/plain" http://$JOB_SERVER_HOST/complete/$JOBNUM > /dev/null
  fi
  echo "Job $JOBNUM complete in $((END-START))s: $RESULT"
done